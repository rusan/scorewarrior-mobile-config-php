events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # JSON логи в stdout/stderr
    log_format json_escaped escape=json
      '{'
        '"ts":"$time_iso8601",'
        '"remote_addr":"$remote_addr",'
        '"method":"$request_method",'
        '"uri":"$request_uri",'
        '"status":$status,'
        '"bytes_sent":$bytes_sent,'
        '"referer":"$http_referer",'
        '"agent":"$http_user_agent",'
        '"req_time":$request_time'
      '}';

    access_log /local/logs/nginx.access.log json_escaped;
    error_log  /local/logs/nginx.error.log warn;

    # Rate limit zones
    limit_req_zone $binary_remote_addr zone=req_zone:10m rate=5r/s;   # for /config
    limit_req_zone $binary_remote_addr zone=health_zone:10m rate=30r/s; # for /health

    # Whitelist for internal networks (used by health/metrics)
    map $remote_addr $health_whitelist {
      default 0;
      127.0.0.1 1;
      10.0.0.0/8 1;
      172.16.0.0/12 1;
      192.168.0.0/16 1;
    }

    # Limit request status and error page
    limit_req_status 429;

    upstream php_fpm {
      server 127.0.0.1:9000;
    }

    server {
      listen 8080;
      server_name _;
      root /local/src/public;
      index index.php;

      # Health: allow only internal networks
      location = /health {
        if ($health_whitelist = 0) { return 403; }
        try_files $uri /index.php$is_args$args;
      }

      # Metrics: allow only internal networks
      location = /metrics {
        if ($health_whitelist = 0) { return 403; }
        try_files $uri /index.php$is_args$args;
      }

      # Rate-limit for /config
      location = /config {
        limit_req zone=req_zone burst=10 nodelay;
        try_files $uri /index.php$is_args$args;
      }

      # JSON response for 429 Too Many Requests
      error_page 429 = @rate_limited;
      location @rate_limited {
        add_header Content-Type application/json;
        return 429 '{"error":{"code":429,"message":"Too many requests"}}';
      }

      location / {
        try_files $uri /index.php$is_args$args;
      }

      location ~ \.php$ {
        include fastcgi_params;
        fastcgi_param REQUEST_URI $request_uri;
        fastcgi_param SCRIPT_NAME /index.php;
        fastcgi_param SCRIPT_FILENAME /local/src/public$fastcgi_script_name;
        fastcgi_pass php_fpm;
        fastcgi_read_timeout 30s;
      }
    }
}
